<script>
    function ajaxGetAsync(url, onReady, onError){
        var xhr = new XMLHttpRequest();
        try {
            var  urlNoCash = url + '&ewrandom='+Math.random();
            xhr.open('GET', urlNoCash, true);
            try {
                xhr.send();
            }
            catch(e){}
            xhr.onreadystatechange = function () { // (3)
                if (xhr.readyState != 4) return;
                if (xhr.status != 200) {
                    onError();
                } else {
                    onReady(xhr.responseText)
                }
            };
        }
        catch(e){
            onError(e);
        }
    }


    window.onmessage = function(e) {
        var msg_id = e.data,
            msg_domain = e.origin,
            parent = window.parent,
            obj, id, token;

        try{
            obj = JSON.parse(localStorage.getItem('ewAuth'));
            id = obj.id;
            token = obj.token;
        }
        catch(e){}

        // Убеждаемся, что ID не "левый"
        try {
            if (msg_id === id) {
                ajaxGetAsync(
                        'http://kionazaki.github.io/tmp/dummy-check-domain.json?id=' + msg_id + '&domain=' + msg_domain,
                        function (r) {
                            // Если домен действительно пренадлежит этому ID
                            if (JSON.parse(r).value) {
                                parent.postMessage(token, "*");
                            } else {
                                parent.postMessage(undefined, "*");
                            }
                        },
                        function (r) {
                            parent.postMessage(undefined, "*");
                        }
                );
            } else {
                parent.postMessage(undefined, "*");
            }
        }
        catch(e){
            parent.postMessage(undefined, "*");
        }
    };

</script>